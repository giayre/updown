name: Movers Alerts

on:
  schedule:
    - cron: "*/30 * * * *"   # ch·∫°y m·ªói 30 ph√∫t (ƒë·ªïi th√†nh */5 n·∫øu mu·ªën 5 ph√∫t)
  workflow_dispatch:

permissions:
  contents: write            # c·∫ßn ƒë·ªÉ commit file state ch·ªëng tr√πng

concurrency:
  group: movers-alerts
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Run script
        env:
          # === B·∫ÆT BU·ªòC: ƒë·∫∑t trong Settings ‚Üí Secrets and variables ‚Üí Actions ===
          TELEGRAM_TOKEN:   ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # === Ngu·ªìn & ng∆∞·ª°ng ph·∫ßn trƒÉm ===
          DATA_SOURCE: "paprika"      # "auto" | "paprika" | "gecko"
          UP_THRESHOLD: "100"
          DOWN_THRESHOLD: "-50"

          # === L·ªçc thanh kho·∫£n & v·ªën ho√° ===
          MIN_VOLUME_24H: "2000000"   # 2M USD; 0 = t·∫Øt l·ªçc
          SHOW_VOLUME: "true"
          MIN_MARKET_CAP: "30000000"  # 50M USD; 0 = t·∫Øt l·ªçc d∆∞·ªõi
          MAX_MARKET_CAP: "0"         # 0 = kh√¥ng gi·ªõi h·∫°n tr√™n
          SHOW_MARKET_CAP: "true"

          # === C√°ch g·ª≠i & gi·ªõi h·∫°n ===
          SEND_PER_COIN: "true"       # "true" = m·ªói coin 1 tin; "false" = g·ªôp 1 tin
          MAX_ITEMS_PER_RUN: "60"
          MAX_DOWN_ITEMS: "60"
          MAX_UP_ITEMS: "60"

          # === Icon (emoji m√†u) ===
          UP_ICON: "‚úÖ"
          DOWN_ICON: "üîª"

          # === Ch·ªëng tr√πng (dedup) ===
          RESEND_DELTA_UP: "100"        # g·ª≠i l·∫°i n·∫øu v∆∞·ª£t th√™m 5 ƒëi·ªÉm % so v·ªõi m·ªëc ƒë√£ g·ª≠i
          RESEND_DELTA_DOWN: "10"
          STATE_PATH: ".state/alerts_state.json"
          STATE_RETENTION_DAYS: "3"   # gi·ªØ 3 ng√†y g·∫ßn nh·∫•t (0 = kh√¥ng d·ªçn)
          DEBUG_DEDUP: "false"        # "true" ƒë·ªÉ in log dedup

          # === D√†nh cho CoinGecko (khi DATA_SOURCE=auto/gecko) ===
          GECKO_PAGES: "1"
          GECKO_PER_PAGE: "250"
          GECKO_BACKOFF_MS: "1200"
        run: node movers.js

      # T·ª± commit file state n·∫øu c√≥ thay ƒë·ªïi (an to√†n, kh√¥ng fail khi kh√¥ng c√≥ thay ƒë·ªïi)
      - name: Commit state (if changed)
        run: |
          set +e
          CHANGED=$(git status --porcelain | grep -c ".state/alerts_state.json" || true)
          set -e
          if [ "$CHANGED" -gt 0 ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .state/alerts_state.json
            git commit -m "chore(state): update alerts_state [skip ci]" || true
            git push
          else
            echo "No state changes."
          fi
